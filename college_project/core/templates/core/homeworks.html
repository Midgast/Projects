{% extends "core/dashboard_base.html" %}

{% block title %}
  {% if mode == "staff" %}Домашние задания — College Core{% else %}Мои домашки — College Core{% endif %}
{% endblock %}

{% block topbar_left %}
  <div class="crumbs">{% if mode == "staff" %}Домашние задания{% else %}Домашки{% endif %}</div>
{% endblock %}

{% block content %}
<section class="page">
  <div class="bento">

    <!-- Summary -->
    <article class="card bento-big tilt" data-tilt>
      <header class="card-h">
        <div>
          <div class="kicker">Задачи</div>
          <h2 class="h2">{% if mode == "staff" %}Домашние задания{% else %}Мои домашки{% endif %}</h2>
        </div>
        <div class="pill subtle">
          Всего: <strong style="margin-left:6px">{{ total_count|default:0 }}</strong>
        </div>
      </header>

      <div class="card-b">
        <div class="grid2">
          <div class="metric">
            <div class="metric-label">Выполнено</div>
            <div class="metric-value">{{ completed_count|default:0 }}</div>
          </div>
          <div class="metric">
            <div class="metric-label">Осталось</div>
            <div class="metric-value">{{ pending_count|default:0 }}</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="split">
          <div class="block">
            <div class="label">Правило</div>
            {% if mode == "staff" %}
              <div class="muted">Преподаватель видит домашки по своим предметам. Директор — всё.</div>
            {% else %}
              <div class="muted">Отмечай выполненное — изменения сохраняются сразу.</div>
            {% endif %}
          </div>
          <div class="block">
            <div class="label">Быстрые действия</div>
            <div class="metric-value">
              {% if mode == "staff" %}
                <a class="btn" href="/admin/core/homework/add/">Добавить</a>
                <a class="btn ghost" href="/admin/core/homework/">Админка</a>
              {% else %}
                <a class="btn ghost" href="/schedule/">Расписание</a>
                <a class="btn ghost" href="/grades/">Оценки</a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </article>

    <!-- List/Table -->
    <article class="card bento-wide tilt" data-tilt>
      <header class="card-h">
        <div>
          <div class="kicker">Список</div>
          <h2 class="h2">{% if mode == "staff" %}Все записи{% else %}Мои задачи{% endif %}</h2>
        </div>
        <div class="pill subtle">
          Показано: {{ homeworks|length|default:0 }}
        </div>
      </header>

      <div class="card-b">
        {% if homeworks %}
          {% if mode == "staff" %}
            <div class="table">
              <div class="tr th">
                <div class="td">Дедлайн</div>
                <div class="td">Группа</div>
                <div class="td">Студент</div>
                <div class="td">Предмет</div>
                <div class="td">Задача</div>
                <div class="td">Статус</div>
              </div>

              {% for h in homeworks %}
                <div class="tr">
                  <div class="td">{{ h.deadline|date:"d.m.Y"|default:"—" }}</div>
                  <div class="td">{{ h.student.group.code|default:"—" }}</div>
                  <div class="td">{{ h.student.user.get_full_name|default:h.student.user.username }}</div>
                  <div class="td">{{ h.subject.name|default:"—" }}</div>
                  <div class="td">{{ h.title|default:h.description|default:"—" }}</div>
                  <div class="td">
                    {% if h.completed %}
                      <span class="pill mini">Готово</span>
                    {% else %}
                      <span class="pill mini subtle">В работе</span>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="hw-list">
              {% for h in homeworks %}
                <div class="hw-row" data-hw-row data-completed="{% if h.completed %}1{% else %}0{% endif %}">
                  <label style="display: contents; cursor: pointer;">
                    <input
                      type="checkbox"
                      class="hw-check"
                      {% if h.completed %}checked{% endif %}
                      data-hw-toggle
                      data-id="{{ h.id }}"
                      {% if not allow_toggle %}disabled{% endif %}
                    >
                    <span class="hw-meta">
                      <span class="hw-title">{{ h.title|default:"Задание" }}</span>
                      <span class="hw-sub muted">
                        {{ h.subject.name|default:"—" }}
                        <span class="sep">·</span>
                        дедлайн: {{ h.deadline|date:"d.m.Y"|default:"—" }}
                      </span>
                    </span>
                    {% if h.completed %}
                      <span class="pill mini">Готово</span>
                    {% else %}
                      <span class="pill mini subtle">В работе</span>
                    {% endif %}
                  </label>
                </div>
              {% endfor %}
            </div>

            <div class="hint" style="margin-top:12px">
              Если чекбоксы не сохраняются — проверь, что подключен <code>static/js/app.js</code> и endpoint toggle в urls.
            </div>
          {% endif %}
        {% else %}
          <div class="empty">
            Домашек пока нет. {% if mode == "staff" %}Добавь через админку.{% else %}Подожди назначения от преподавателя.{% endif %}
          </div>
        {% endif %}
      </div>
    </article>

  </div>
</section>
{% endblock %}
