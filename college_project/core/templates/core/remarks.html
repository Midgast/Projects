{% extends "core/dashboard_base.html" %}

{% block title %}Замечания — College Core{% endblock %}

{% block topbar_left %}
  <div class="crumbs">Замечания</div>
{% endblock %}

{% block content %}
<section class="page">
  <div class="bento">

    <!-- Summary -->
    <article class="card bento-big tilt" data-tilt>
      <header class="card-h">
        <div>
          <div class="kicker">Цифровая система</div>
          <h2 class="h2">Замечания</h2>
        </div>

        <div class="pill">
          Открытые: <strong style="margin-left:6px">{{ open_count|default:"—" }}</strong>
        </div>
      </header>

      <div class="card-b">
        <div class="split">
          <div class="block">
            <div class="label">Статус</div>
            <div class="big">
              {% if open_count|default:0 %}
                Требуют внимания
              {% else %}
                Всё спокойно
              {% endif %}
            </div>
          </div>

          <div class="block">
            <div class="label">Правило</div>
            <div class="muted">
              Замечания фиксируются преподавателями и могут быть закрыты (resolved) через админку.
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <form method="get" class="form">
          <select class="input" name="status">
            <option value="" {% if not status %}selected{% endif %}>Все</option>
            <option value="open" {% if status == "open" %}selected{% endif %}>Только открытые</option>
            <option value="closed" {% if status == "closed" %}selected{% endif %}>Только закрытые</option>
          </select>

          <select class="input" name="level">
            <option value="" {% if not level %}selected{% endif %}>Все уровни</option>
            <option value="INFO" {% if level == "INFO" %}selected{% endif %}>INFO</option>
            <option value="WARN" {% if level == "WARN" %}selected{% endif %}>WARN</option>
            <option value="CRITICAL" {% if level == "CRITICAL" %}selected{% endif %}>CRITICAL</option>
          </select>

          <button class="btn" type="submit">Применить</button>
        </form>
      </div>
    </article>

    <!-- List -->
    <article class="card bento-wide tilt" data-tilt>
      <header class="card-h">
        <div>
          <div class="kicker">Лента</div>
          <h2 class="h2">
            {% if request.user.teacher %}Замечания по студентам{% else %}Мои замечания{% endif %}
          </h2>
        </div>
        <div class="pill subtle">
          Всего: {{ remarks|length|default:0 }}
        </div>
      </header>

      <div class="card-b">
        {% if remarks %}
          <div class="list">
            {% for r in remarks %}
              <div class="list-item {% if r.resolved %}is-done{% endif %}">
                <div class="check {% if r.resolved %}on{% endif %}">
                  {% if r.resolved %}✓{% else %}&nbsp;{% endif %}
                </div>

                <div class="list-main">
                  <div class="list-title">
                    <span class="pill mini {% if r.level == 'CRITICAL' %}danger{% elif r.level == 'WARN' %}warn{% else %}subtle{% endif %}">
                      {{ r.level|default:"INFO" }}
                    </span>
                    <span style="margin-left:10px">{{ r.text|default:"—" }}</span>
                  </div>

                  <div class="list-sub">
                    {% if request.user.teacher %}
                      Студент:
                      <strong>
                        {{ r.student.user.username|default:"—" }}
                      </strong>
                      <span class="sep">·</span>
                    {% endif %}

                    Преподаватель:
                    <strong>
                      {% if r.teacher %}
                        {{ r.teacher.user.username|default:"—" }}
                      {% else %}
                        —
                      {% endif %}
                    </strong>

                    <span class="sep">·</span>

                    Дата:
                    <strong>{{ r.created_at|date:"d.m.Y H:i"|default:"—" }}</strong>

                    <span class="sep">·</span>

                    Статус:
                    <strong>{% if r.resolved %}Закрыто{% else %}Открыто{% endif %}</strong>
                  </div>
                </div>

                <div class="list-actions">
                  {% if request.user.is_staff %}
                    <a class="btn ghost" href="/admin/core/remark/{{ r.id }}/change/">Открыть в админке</a>
                  {% else %}
                    <span class="pill mini {% if r.resolved %}subtle{% else %}warn{% endif %}">
                      {% if r.resolved %}OK{% else %}В работе{% endif %}
                    </span>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="empty">
            Замечаний пока нет. Если ты преподаватель — добавь через админку <code>Remarks</code>.
          </div>
        {% endif %}
      </div>
    </article>

    <!-- Hint -->
    <article class="card bento-small tilt" data-tilt>
      <header class="card-h">
        <div>
          <div class="kicker">Подсказка</div>
          <h2 class="h2">Как закрывать</h2>
        </div>
      </header>
      <div class="card-b">
        <ol class="steps">
          <li>Зайди в <span class="mono">/admin/</span></li>
          <li>Открой <span class="mono">Remarks</span></li>
          <li>Поставь <span class="mono">resolved</span> и сохрани</li>
        </ol>
      </div>
    </article>

  </div>
</section>
{% endblock %}
