{% extends "core/dashboard_base.html" %}

{% block title %}Директор — Dashboard{% endblock %}

{% block topbar_left %}
  <div class="crumbs">Директор • Обзор системы</div>
{% endblock %}

{% block content %}
<section class="page">
  <div class="bento">

    <!-- System Overview (BIG) -->
    <article class="card bento-big tilt" data-tilt>
      <header class="card-h">
        <div>
          <div class="kicker">Администрирование</div>
          <h2 class="h2">Состояние колледжа</h2>
        </div>
        <div class="pill subtle">
          Открытых замечаний: <strong style="margin-left:6px">{{ stats.open_remarks|default:0 }}</strong>
        </div>
      </header>

      <div class="card-b">
        <div class="grid3">
          <div class="metric">
            <div class="metric-label">Студенты</div>
            <div class="metric-value">{{ stats.students|default:0 }}</div>
          </div>
          <div class="metric">
            <div class="metric-label">Преподаватели</div>
            <div class="metric-value">{{ stats.teachers|default:0 }}</div>
          </div>
          <div class="metric">
            <div class="metric-label">Открытые замечания</div>
            <div class="metric-value">{{ stats.open_remarks|default:0 }}</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="split">
          <div class="block">
            <div class="label">Быстрые действия</div>
            <div class="actions">
              <a class="btn" href="/admin/">Админка</a>
              <a class="btn ghost" href="/remarks/">Замечания</a>
              <a class="btn ghost" href="/grades/">Оценки</a>
              <a class="btn ghost" href="/homeworks/">Домашки</a>
              <a class="btn ghost" href="/schedule/">Расписание</a>
            </div>
          </div>

          <div class="block">
            <div class="label">Контроль качества</div>
            <div class="muted">
              Директор видит систему целиком. Если у директора есть профиль преподавателя — ниже появится блок “Режим преподавателя”
              (твои пары, группы и личные замечания).
            </div>
          </div>
        </div>
      </div>
    </article>

    <!-- Teacher mode (MEDIUM) -->
    <article class="card bento-small tilt" data-tilt>
      <header class="card-h">
        <div>
          <div class="kicker">Роль</div>
          <h2 class="h2">Режим преподавателя</h2>
        </div>
        {% if teacher_mode %}
          <span class="pill mini">Включен</span>
        {% else %}
          <span class="pill mini subtle">Нет профиля</span>
        {% endif %}
      </header>

      <div class="card-b">
        {% if teacher_mode %}
          <div class="metric">
            <div class="metric-label">Мои открытые замечания</div>
            <div class="metric-value">{{ my_open_remarks|default:0 }}</div>
          </div>

          <div class="divider"></div>

          <div class="label">Мои группы</div>
          {% if groups %}
            <div class="chips">
              {% for g in groups %}
                <span class="pill mini subtle">{{ g.code }}</span>
              {% endfor %}
            </div>
          {% else %}
            <div class="empty">Группы не найдены.</div>
          {% endif %}
        {% else %}
          <div class="empty">
            Профиль преподавателя не привязан. Создай Teacher для этого пользователя в админке.
          </div>
          <div style="margin-top:10px">
            <a class="btn ghost" href="/admin/core/teacher/add/">Создать Teacher</a>
          </div>
        {% endif %}
      </div>
    </article>

    <!-- Next lesson (MEDIUM) -->
    <article class="card bento-small tilt" data-tilt>
      <header class="card-h">
        <div>
          <div class="kicker">Фокус</div>
          <h2 class="h2">Следующая пара</h2>
        </div>
        <span class="pill mini subtle" id="countdownPill">—</span>
      </header>

      <div class="card-b">
        {% if teacher_mode and next_lesson %}
          <div class="row">
            <div class="label">Предмет</div>
            <div class="value">{{ next_lesson.subject.name|default:"—" }}</div>
          </div>
          <div class="row">
            <div class="label">Группа</div>
            <div class="value">{{ next_lesson.group.code|default:"—" }}</div>
          </div>
          <div class="row">
            <div class="label">Кабинет</div>
            <div class="value">{{ next_lesson.location|default:"—" }}</div>
          </div>
          <div class="row">
            <div class="label">Время</div>
            <div class="value">
              {{ next_lesson.time_start|time:"H:i" }}–{{ next_lesson.time_end|time:"H:i" }}
            </div>
          </div>

          <div class="divider"></div>

          <div class="muted">
            Таймер считает до начала пары (локальное время).
          </div>

          <div id="nextLessonTs" data-ts="{{ timestamp_ms|default:0 }}"></div>
        {% else %}
          <div class="empty">
            {% if teacher_mode %}
              Нет ближайшей пары.
            {% else %}
              Доступно только при teacher-mode.
            {% endif %}
          </div>
        {% endif %}
      </div>
    </article>

    <!-- News (WIDE) -->
    <article class="card bento-wide tilt" data-tilt>
      <header class="card-h">
        <div>
          <div class="kicker">Новости</div>
          <h2 class="h2">Актуальное</h2>
        </div>
        <a class="btn ghost" href="/news/">Все</a>
      </header>

      <div class="card-b">
        {% if news %}
          <div class="news-grid">
            {% for n in news %}
              <a class="news-item" href="/news/" aria-label="{{ n.title }}">
                {% if n.image %}
                  <img class="news-img" src="{{ n.image.url }}" alt="{{ n.title }}">
                {% endif %}
                <div class="news-meta">
                  <div class="news-title">{{ n.title }}</div>
                  <div class="news-text">{{ n.text|truncatechars:120 }}</div>
                </div>
              </a>
            {% endfor %}
          </div>
        {% else %}
          <div class="empty">Пока нет новостей.</div>
        {% endif %}
      </div>
    </article>

  </div>
</section>

<script>
(() => {
  const holder = document.getElementById("nextLessonTs");
  const pill = document.getElementById("countdownPill");
  if (!holder || !pill) return;

  const ts = Number(holder.dataset.ts || "0");
  if (!ts) { pill.textContent = "—"; return; }

  function fmt(ms) {
    const s = Math.max(0, Math.floor(ms / 1000));
    const m = Math.floor(s / 60);
    const h = Math.floor(m / 60);
    const mm = m % 60;
    const ss = s % 60;
    if (h > 0) return `${h}ч ${mm}м`;
    if (m > 0) return `${m}м ${ss}с`;
    return `${ss}с`;
  }

  function tick() {
    const left = ts - Date.now();
    if (left <= 0) {
      pill.textContent = "Сейчас";
      return;
    }
    pill.textContent = `через ${fmt(left)}`;
    requestAnimationFrame(() => setTimeout(tick, 250));
  }

  tick();
})();
</script>
{% endblock %}
